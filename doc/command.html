<!DOCTYPE html>

<html>
<head>
  <title>command.litkal</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="ast.html">
                ast.litkal
              </a>
            
              
              <a class="source" href="command.html">
                command.litkal
              </a>
            
              
              <a class="source" href="generator.html">
                generator.litkal
              </a>
            
              
              <a class="source" href="grammar.html">
                grammar.litkal
              </a>
            
              
              <a class="source" href="interactive.html">
                interactive.litkal
              </a>
            
              
              <a class="source" href="kal.html">
                kal.litkal
              </a>
            
              
              <a class="source" href="lexer.html">
                lexer.litkal
              </a>
            
              
              <a class="source" href="literate.html">
                literate.litkal
              </a>
            
              
              <a class="source" href="parser.html">
                parser.litkal
              </a>
            
              
              <a class="source" href="sugar.html">
                sugar.litkal
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>command.litkal</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2>Command Line Utility</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This module defines the command line <code>kal</code> utility.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs             = <span class="built_in">require</span> <span class="string">'fs'</span>
path           = <span class="built_in">require</span> <span class="string">'path'</span>
Kal            = <span class="built_in">require</span> <span class="string">'./kal'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1>Utilities</h1>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Some messages are written to <code>stderr</code> in this module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">warn</span><span class="params">(line)</span></span>
  process.stderr.write line + <span class="string">'\n'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This utility function checks if a file is “hidden” by the operating system.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">hidden</span><span class="params">(file)</span></span>
  <span class="regexp">/^\.|~$/</span>.test file</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>parseOptions</code> parses the command line switches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">parseOptions</span><span class="params">()</span></span>
  options = {}
  <span class="keyword">for</span> arg <span class="keyword">in</span> process.argv
    <span class="keyword">if</span> arg[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'-'</span> <span class="keyword">and</span> arg[<span class="number">1</span>] <span class="keyword">isnt</span> <span class="string">'-'</span>
      options.help       = <span class="literal">yes</span> <span class="keyword">if</span> <span class="string">'h'</span> <span class="keyword">in</span> arg
      options.tokens     = <span class="literal">yes</span> <span class="keyword">if</span> <span class="string">'t'</span> <span class="keyword">in</span> arg
      options.javascript = <span class="literal">yes</span> <span class="keyword">if</span> <span class="string">'j'</span> <span class="keyword">in</span> arg
      options.bare       = <span class="literal">yes</span> <span class="keyword">if</span> <span class="string">'b'</span> <span class="keyword">in</span> arg
      options.version    = <span class="literal">yes</span> <span class="keyword">if</span> <span class="string">'v'</span> <span class="keyword">in</span> arg
      options.minify     = <span class="literal">yes</span> <span class="keyword">if</span> <span class="string">'m'</span> <span class="keyword">in</span> arg
    <span class="keyword">else</span> <span class="keyword">if</span> arg[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'-'</span> <span class="keyword">and</span> arg[<span class="number">1</span>] <span class="keyword">is</span> <span class="string">'-'</span>
      options.help       = <span class="literal">yes</span> <span class="keyword">if</span> arg <span class="keyword">is</span> <span class="string">'--help'</span>
      options.tokens     = <span class="literal">yes</span> <span class="keyword">if</span> arg <span class="keyword">is</span> <span class="string">'--tokens'</span>
      options.javascript = <span class="literal">yes</span> <span class="keyword">if</span> arg <span class="keyword">is</span> <span class="string">'--javascript'</span>
      options.bare       = <span class="literal">yes</span> <span class="keyword">if</span> arg <span class="keyword">is</span> <span class="string">'--bare'</span>
      options.version    = <span class="literal">yes</span> <span class="keyword">if</span> arg <span class="keyword">is</span> <span class="string">'--version'</span>
      options.minify     = <span class="literal">yes</span> <span class="keyword">if</span> arg <span class="keyword">is</span> <span class="string">'--minify'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <code>-o</code> option has an argument (the output directory).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> <span class="string">'-o'</span> <span class="keyword">in</span> process.argv
    index = process.argv.indexOf <span class="string">'-o'</span>
  <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">'--output'</span> <span class="keyword">in</span> process.argv
    index = process.argv.indexOf <span class="string">'--output'</span>

  options.output = process.argv[index + <span class="number">1</span>] <span class="keyword">if</span> index <span class="keyword">isnt</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The remaining arguments are assumed to be input file names. We loop through the array and ignore switches and the output directory (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  inputs = []
  <span class="keyword">for</span> arg <span class="keyword">in</span> process.argv.slice(<span class="number">2</span>)
    <span class="keyword">if</span> arg[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'-'</span> <span class="keyword">or</span> arg <span class="keyword">is</span> options.output</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Set the help flag if the user passed input files (or extra arguments) that were followed by other switches like <code>kal -o output_dir some_file -j</code>. This is considered invalid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options.help = <span class="literal">yes</span> <span class="keyword">if</span> inputs.length <span class="keyword">isnt</span> <span class="number">0</span>
      inputs = []</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Otherwise, add the argument to the list of input files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span>
      inputs.push arg
  options._ = inputs
  <span class="keyword">return</span> options</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>existsSync</code> is used to retain compatibility between node.js versions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>existsSync = fs.existsSync <span class="keyword">or</span> path.existsSync</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h1>Main</h1>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Parse the command line options and print the version/usage if necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options = parseOptions()
  <span class="keyword">return</span> version() <span class="keyword">if</span> options.version
  <span class="keyword">return</span> usage() <span class="keyword">if</span> options.help</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Check the output path (if specified) and make sure it is valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> options.output <span class="keyword">exists</span> <span class="keyword">and</span> <span class="keyword">not</span> existsSync(options.output)
    warn(<span class="string">'output path does not exist!'</span>)
    <span class="keyword">return</span> usage()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If no input files are specified, start the interactive shell.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'./interactive'</span>) <span class="keyword">if</span> options._.length <span class="keyword">is</span> <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Let scripts know we are running in <code>kal</code> not <code>node</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  process.argv[<span class="number">0</span>] = <span class="string">'kal'</span>
  process.execPath = require.main.filename</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Construct the <code>compile_options</code> argument for <code>Kal.compile</code> or <code>Kal.eval</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  compile_options =
    <span class="attribute">show_tokens</span>: options.tokens
    <span class="attribute">bare</span>:        options.bare
    <span class="attribute">show_js</span>:     options.javascript</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If an output argument was specified, we are writing JavaScript files to an output directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> options.output <span class="keyword">exists</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Attempt to load <code>uglify-js</code> if the user wants to minify files. This is not listed as a dependency so the user needs it installed globally or manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">try</span>
      <span class="built_in">require</span>(<span class="string">'uglify-js'</span>) <span class="keyword">if</span> options.minify
    <span class="keyword">catch</span>
      warn <span class="string">'error: uglify-js must be installed to use the --minify option'</span>
      process.exit(<span class="number">3</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If the user just specified one directory, assume they just want all the files in it. Compile the list of files with the given options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> options._.length <span class="keyword">is</span> <span class="number">1</span> <span class="keyword">and</span> fs.statSync(options._[<span class="number">0</span>]).isDirectory()
      files = [path.join(options._[<span class="number">0</span>],file) <span class="keyword">for</span> file <span class="keyword">in</span> fs.readdirSync(options._[<span class="number">0</span>])]
      compile_files files, options.output, compile_options, options.minify
    <span class="keyword">else</span>
      compile_files options._, options.output, compile_options, options.minify
  <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If no output was specified, just run the script using <code>eval</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> filename <span class="keyword">in</span> options._
      compile_options.literate = path.extname(filename) <span class="keyword">in</span> [<span class="string">'.litkal'</span>, <span class="string">'.md'</span>]
      Kal.eval fs.readFileSync(filename), compile_options</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The <code>scripts/kal</code> loader calls this entry point.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="reserved">export</span>s.<span class="keyword">run</span> = <span class="keyword">run</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h1>Compile Files</h1>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>This function recursively compiles a list of files/directories into <code>output_dir</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">compile_files</span><span class="params">(filenames, output_dir, options, minify)</span></span>
  <span class="keyword">for</span> filename <span class="keyword">in</span> filenames
    stat = fs.statSync filename</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If this file is a directory, get a list of files in the directory and call this function recursively.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> stat.isDirectory()
      new_outdir = path.join(output_dir, path.basename(filename))
      fs.mkdirSync new_outdir, stat.mode
      subfiles = [path.join(filename, child) <span class="keyword">for</span> child <span class="keyword">in</span> fs.readdirSync(filename)]
      compile_files subfiles, new_outdir, options, minify</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>For <code>.kal</code>, <code>.litkal</code>, and <code>.md</code> (literate Kal assumed) files, set up the options structure and call <code>Kal.compile</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span> <span class="keyword">if</span> path.extname(filename) <span class="keyword">in</span> [<span class="string">'.kal'</span>, <span class="string">'.litkal'</span>, <span class="string">'.md'</span>]
      extension = path.extname(filename)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Check if this is Literate code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options.literate = extension <span class="keyword">in</span> [<span class="string">'.litkal'</span>, <span class="string">'.md'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Compile the source.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      js_output = Kal.compile fs.readFileSync(filename), options</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Minify if requested. We&#39;ve already checked that <code>uglify-js</code> is installed at this point.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> minify
        js_output = <span class="built_in">require</span>(<span class="string">'uglify-js'</span>).minify(js_output, {<span class="attribute">fromString</span>:<span class="literal">yes</span>,<span class="attribute">mangle</span>:<span class="literal">no</span>}).code</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Print out the JavaScript if the debug option was passed in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="built_in">print</span> js_output <span class="keyword">if</span> options.show_js</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Write the output to the output directory with a <code>.js</code> extension.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      js_filename = path.join(output_dir, path.basename(filename, extension)) + <span class="string">'.js'</span>
      fs.writeFileSync js_filename, js_output</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h1>Version</h1>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Returns the Kal version when for the <code>-v</code> switch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">version</span><span class="params">()</span></span>
  <span class="built_in">print</span> <span class="string">"Kal version <span class="subst">#{Kal.VERSION}</span>"</span>
  process.exit(<span class="number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Help options or invalid input will cause this message to print to the screen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">usage</span><span class="params">()</span></span>
  <span class="built_in">print</span> <span class="string">"Usage: kal [options] SOURCE [-o OUTPUT_DIR]"</span>
  <span class="built_in">print</span> <span class="string">""</span>
  <span class="built_in">print</span> <span class="string">"If called without the -o option, `kal` will run SOURCE."</span>
  <span class="built_in">print</span> <span class="string">"If called without any options, `kal` will start an interactive session."</span>
  <span class="built_in">print</span> <span class="string">""</span>
  <span class="built_in">print</span> <span class="string">""</span>
  <span class="built_in">print</span> <span class="string">"Options:"</span>
  <span class="built_in">print</span> <span class="string">"  --help, -h        show the command line usage options                  [boolean]"</span>
  <span class="built_in">print</span> <span class="string">"  --tokens, -t      print out the tokens that the lexer/sugarer produce  [boolean]"</span>
  <span class="built_in">print</span> <span class="string">"  --javascript, -j  print out the compiled javascript                    [boolean]"</span>
  <span class="built_in">print</span> <span class="string">"  --bare, -b        don't wrap the output in a function                  [boolean]"</span>
  <span class="built_in">print</span> <span class="string">"  --version, -v     display the version number                           [boolean]"</span>
  <span class="built_in">print</span> <span class="string">"  --output, -o      the output directory for the compiled source"</span>
  <span class="built_in">print</span> <span class="string">"  --minify          minify the output (requires uglify-js)               [boolean]"</span>
  process.exit(<span class="number">2</span>)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
